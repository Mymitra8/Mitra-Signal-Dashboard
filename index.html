<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mitra Signals — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--bg:#F6F9FF;--card:#fff;--accent:#0b5cff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#0b1220}
    header{background:linear-gradient(90deg,var(--accent),#3b82f6);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .wrap{max-width:1100px;margin:14px auto;padding:12px;display:grid;grid-template-columns:320px 1fr;gap:14px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(11,17,32,0.06)}
    h3{margin:0 0 10px 0;color:#0b3ea6}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700}
    button.alt{background:#475569}
    select,input[type="text"]{padding:8px;border-radius:8px;border:1px solid #e6eef8}
    .mini{display:inline-block;padding:6px 8px;background:#eef2ff;color:var(--accent);border-radius:999px;font-weight:700}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:middle}
    th{background:#fbfdff;position:sticky;top:0;color:#41516a;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .chart-wrap{height:240px}
    @media(max-width:980px){ .wrap{grid-template-columns:1fr} .chart-wrap{height:200px} table{font-size:12px} }
    a.link{color:var(--accent);font-weight:700;text-decoration:none}
  </style>

  <!-- Google Charts loader -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    google.charts.load('current', {'packages':['corechart','table','bar']});
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard(){
      // Only run when google charts & Apps Script environment are ready
      if (typeof google === 'undefined' || typeof google.script === 'undefined') {
        // Not running inside Apps Script HTMLService — inform user
        document.addEventListener('DOMContentLoaded', function(){
          document.body.innerHTML = '<div style="padding:20px;font-family:Arial">This dashboard must be opened via the <strong>Apps Script Web App URL</strong>. Open the Web App from the Apps Script deployment — do not open this file directly.</div>';
        });
        return;
      }
      refreshAll();
      setInterval(refreshAll, 20000);
    }
  </script>
</head>
<body>
  <header>
    <div style="font-weight:800">Mitra Signals — Dashboard</div>
    <div style="font-size:13px">Trade Alerts • Sheet: <strong>Trade Alerts</strong></div>
  </header>

  <div class="wrap">
    <!-- Controls -->
    <div class="card">
      <h3>Engine Control</h3>
      <div class="controls">
        <button id="btnStart" onclick="startEngine()">▶ Start</button>
        <button id="btnStop" class="alt" onclick="stopEngine()">⏸ Stop</button>
        <button onclick="manualTick()">⚡ Manual</button>
      </div>

      <div style="margin-top:10px">
        <label style="font-weight:700">Strategy</label><br/>
        <select id="strategy" onchange="changeStrategy()">
          <option>MomentumBurst</option>
          <option>TrendRider</option>
          <option>VolumeSurge</option>
          <option>MeanRevertSnap</option>
        </select>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <div class="mini" id="runningStatus">Loading...</div>
        <div class="mini" id="alertsCount">Alerts: 0</div>
      </div>

      <h3 style="margin-top:14px">Quick Filters</h3>
      <div class="filters">
        <select id="fStrategy" onchange="applyFilters()"><option value="">All Strategies</option><option>MomentumBurst</option><option>TrendRider</option><option>VolumeSurge</option><option>MeanRevertSnap</option></select>
        <select id="fDirection" onchange="applyFilters()"><option value="">Any Direction</option><option>BUY</option><option>SELL</option></select>
        <input type="text" id="q" placeholder="Search Coin / Symbol" oninput="applyFilters()" />
        <button onclick="clearFilters()">Clear</button>
      </div>

      <h3 style="margin-top:12px">Diagnostics</h3>
      <pre id="diag" class="muted" style="height:110px;overflow:auto;padding:8px;border-radius:8px;background:#f7fbff"></pre>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button onclick="openSheet()">Open Sheet</button>
        <button onclick="openRepo()">Open Repo</button>
      </div>
    </div>

    <!-- Chart + table -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3>Latest Alerts</h3><div class="muted">Newest alerts near top. Tap Chart to open TradingView.</div></div>
        <div><button onclick="fetchAlerts()">Refresh</button></div>
      </div>

      <div class="chart-wrap" id="chart_div" style="margin-top:10px"></div>

      <div style="margin-top:10px;overflow:auto;max-height:420px">
        <table>
          <thead>
            <tr>
              <th>Time</th><th>Strat</th><th>Coin</th><th>Sym</th><th>Entry</th><th>TP</th><th>SL</th><th>Conf%</th><th>24h%</th><th>Vol</th><th>Dir</th><th>Status</th><th>Chart</th>
            </tr>
          </thead>
          <tbody id="alertsBody"><tr><td colspan="13" class="muted">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  function gsRun(fn, callback){
    google.script.run.withSuccessHandler(function(res){ try { callback(res); } catch(e){ console.error(e); } })[fn]();
  }

  let ALL_ALERTS = [];

  function refreshAll(){ loadDiagnostics(); fetchAlerts(); }

  function loadDiagnostics(){
    gsRun('api_getDiagnostics', function(js){
      if (!js || !js.success){ document.getElementById('diag').innerText = 'Unable to fetch diagnostics'; document.getElementById('runningStatus').innerText = 'Unknown'; return; }
      const d = js.data;
      document.getElementById('diag').innerText = JSON.stringify(d, null, 2);
      document.getElementById('runningStatus').innerText = d.isRunning ? 'Running' : 'Stopped';
      document.getElementById('strategy').value = d.activeStrategy || 'MomentumBurst';
      document.getElementById('alertsCount').innerText = 'Alerts: ' + (d.dailyAlerts || 0);
    });
  }

  function fetchAlerts(){
    gsRun('api_getAlerts', function(js){
      if (!js || !js.success){ document.getElementById('alertsBody').innerHTML = '<tr><td colspan="13" class="muted">Failed to load alerts</td></tr>'; drawChart([]); return; }
      ALL_ALERTS = js.alerts || [];
      ALL_ALERTS.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
      applyFilters();
    });
  }

  function applyFilters(){
    const strat = document.getElementById('fStrategy').value;
    const dir = document.getElementById('fDirection').value;
    const q = (document.getElementById('q').value || '').trim().toLowerCase();
    const filtered = ALL_ALERTS.filter(a=>{
      if (strat && a.strategy !== strat) return false;
      if (dir && a.direction !== dir) return false;
      if (q){
        if ((a.coin||'').toString().toLowerCase().indexOf(q) >= 0) return true;
        if ((a.symbol||'').toString().toLowerCase().indexOf(q) >= 0) return true;
        return false;
      }
      return true;
    });
    renderTable(filtered);
    drawChart(filtered);
  }

  function clearFilters(){ document.getElementById('fStrategy').value=''; document.getElementById('fDirection').value=''; document.getElementById('q').value=''; applyFilters(); }

  function renderTable(alerts){
    const body = document.getElementById('alertsBody');
    body.innerHTML = '';
    if (!alerts || alerts.length === 0){ body.innerHTML = '<tr><td colspan="13" class="muted">No alerts found.</td></tr>'; return; }
    alerts.forEach(a=>{
      const tr = document.createElement('tr');
      const time = a.timestamp ? (new Date(a.timestamp)).toLocaleString() : '-';
      const entry = a.entry !== undefined && a.entry !== null ? Number(a.entry).toFixed(8) : '-';
      const tp = a.tp !== undefined && a.tp !== null ? Number(a.tp).toFixed(8) : '-';
      const sl = a.stop !== undefined && a.stop !== null ? Number(a.stop).toFixed(8) : '-';
      const vol = a.volumeUSD ? Number(a.volumeUSD).toFixed(0) : '-';
      const chartLink = a.link ? `<a class="link" href="${a.link}" target="_blank">Chart</a>` : '-';
      tr.innerHTML = `<td>${time}</td>
                      <td>${escapeHtml(a.strategy||'')}</td>
                      <td>${escapeHtml(a.coin||'')}</td>
                      <td>${escapeHtml(a.symbol||'')}</td>
                      <td>${entry}</td>
                      <td>${tp}</td>
                      <td>${sl}</td>
                      <td>${a.confidence || '-'}</td>
                      <td>${a.change24h !== undefined ? Number(a.change24h).toFixed(2) : '-'}</td>
                      <td>${vol}</td>
                      <td>${escapeHtml(a.direction||'-')}</td>
                      <td>${escapeHtml(a.status||'-')}</td>
                      <td>${chartLink}</td>`;
      body.appendChild(tr);
    });
  }

  function drawChart(alerts){
    try {
      const stratCounts = {};
      alerts.forEach(a=>{ stratCounts[a.strategy] = (stratCounts[a.strategy]||0) + 1; });
      const data = new google.visualization.DataTable();
      data.addColumn('string','Strategy');
      data.addColumn('number','Count');
      if (Object.keys(stratCounts).length === 0) data.addRow(['No alerts',1]);
      else for (const s in stratCounts) data.addRow([s, stratCounts[s]]);
      const options = { title: 'Alerts by Strategy', pieHole: 0.4, height: 220, legend: { position: 'right' } };
      const chart = new google.visualization.PieChart(document.getElementById('chart_div'));
      chart.draw(data, options);
    } catch(e){ console.error('drawChart err', e); }
  }

  // engine controls
  function startEngine(){
    if (typeof google === 'undefined' || typeof google.script === 'undefined') { alert('Open this dashboard via the Apps Script WebApp URL.'); return; }
    const strat = document.getElementById('strategy').value;
    google.script.run.withSuccessHandler(refreshAll).api_startEngine(strat);
  }
  function stopEngine(){ if (typeof google === 'undefined' || typeof google.script === 'undefined') { alert('Open via WebApp URL.'); return; } google.script.run.withSuccessHandler(refreshAll).api_stopEngine(); }
  function manualTick(){ if (typeof google === 'undefined' || typeof google.script === 'undefined') { alert('Open via WebApp URL.'); return; } google.script.run.withSuccessHandler(function(res){ alert('Manual run done. Sent: ' + (res.sent||0)); refreshAll(); }).api_manualTick(); }
  function changeStrategy(){ const s = document.getElementById('strategy').value; google.script.run.withSuccessHandler(loadDiagnostics).api_changeStrategy(s); }

  function openSheet(){ window.open('https://docs.google.com/spreadsheets/d/1xBD2DvIaYYrl-m5MdqAvwvwdFZQLoiR2tJfGht5buWI','_blank'); }
  function openRepo(){ window.open('https://github.com/Mymitra8/Mitra-Signal-Dashboard','_blank'); }

  function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
</script>
</body>
</html>
