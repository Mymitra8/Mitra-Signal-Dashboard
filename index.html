<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mitra Signals — Dashboard</title>
<style>
:root{--bg:#071029;--card:#0f1724;--muted:#9fb4ff;--accent:#4da3ff}
body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071029,#081025);color:#e6f0ff}
.header{display:flex;align-items:center;padding:12px 18px;background:rgba(255,255,255,0.02)}
.logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#324fd6,#19b3ff);display:flex;align-items:center;justify-content:center}
.title{margin-left:12px;font-weight:700}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#021022;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.grid{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
.card{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.small{font-size:12px;color:#9fb4ff}
.table{width:100%;border-collapse:collapse}
.table th{color:#9fb4ff;text-align:left;padding:8px}
.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
pre{white-space:pre-wrap;word-wrap:break-word}
.admin{display:flex;gap:8px;align-items:center;margin-top:8px}
@media(max-width:900px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="header">
    <div class="logo">M</div>
    <div class="title">Mitra Signals — Dashboard</div>
    <div class="controls">
      <select id="strategy">
        <option value="MomentumBurst">Momentum Burst</option>
        <option value="BreakoutPullback">Breakout Pullback</option>
        <option value="MeanReversion">Mean Reversion</option>
      </select>
      <button id="start" class="btn">Start</button>
      <button id="stop" class="btn" style="background:#ff6b6b">Stop</button>
      <button id="manual" class="btn" style="background:#334155">Manual Scan</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div class="small">Engine Status</div>
        <div id="status" style="font-weight:700;font-size:18px">—</div>
        <div class="small" style="margin-top:8px">Active Strategy: <span id="active">—</span></div>
        <div class="small" style="margin-top:8px">Last API: <span id="lastApi">—</span></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="small">Today Alerts</div>
        <div id="today" style="font-weight:700;font-size:18px">0</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="small">Diagnostics</div>
        <pre id="diag" style="height:260px;overflow:auto;color:#cfe6ff"></pre>
        <div class="admin">
          <input id="adminKey" placeholder="ADMIN_KEY" style="padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6f0ff"/>
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="forcePublic"> Force Public API
          </label>
          <button id="applyForce" class="btn" style="background:#2b6cb0">Apply</button>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Recent Alerts</strong><div class="small">Top 15 (most recent)</div></div>
          <div><button id="refresh" class="btn">Refresh</button></div>
        </div>

        <table class="table" style="margin-top:12px">
          <thead><tr><th>Time</th><th>Coin</th><th>Sym</th><th>Conf</th><th>Entry</th><th>TP</th><th>SL</th></tr></thead>
          <tbody id="alerts"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="small">Live Chart (click a symbol)</div>
        <iframe id="chart" style="width:100%;height:420px;border:0;margin-top:8px"></iframe>
      </div>
    </div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxi2iD44e_wBojx2Tz1fQxgFvTUZXuEjfsWCceG6j4hy_qTYsN3wld_SC4eHXdNp39V/exec'; // update if you redeploy

async function apiGet(params){
  const u = new URL(WEB_APP_URL);
  Object.keys(params||{}).forEach(k => u.searchParams.set(k, params[k]));
  const r = await fetch(u.toString(), { cache:'no-store' });
  return r;
}

async function refreshAll(){
  try {
    const r = await apiGet({ type:'status', t:Date.now() });
    const j = await r.json();
    if (j && j.success !== false && j.data){
      document.getElementById('status').textContent = j.data.isRunning ? 'Running' : 'Stopped';
      document.getElementById('active').textContent = j.data.activeStrategy;
      document.getElementById('today').textContent = j.data.todayCount || 0;
      document.getElementById('strategy').value = j.data.activeStrategy || 'MomentumBurst';
    }
  } catch(e){ console.error(e); }
  await loadAlerts();
  await loadDiagnosticsJSON();
}

async function loadAlerts(){
  try {
    const r = await apiGet({ type:'alerts', t:Date.now() });
    const j = await r.json();
    const rows = j.data || [];
    const tbody = document.getElementById('alerts'); tbody.innerHTML = '';
    if (!rows.length){ tbody.innerHTML = '<tr><td colspan="7">No alerts</td></tr>'; document.getElementById('lastApi').textContent = 'No alerts yet'; return; }
    rows.slice(0,15).forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(a.timestamp).toLocaleString()}</td>
                      <td><a href="${a.link||'#'}" target="_blank">${a.coin||''}</a></td>
                      <td>${a.symbol||''}</td>
                      <td>${a.confidence||''}</td>
                      <td>₹${fmt(a.entry)}</td>
                      <td>₹${fmt(a.tp)}</td>
                      <td>₹${fmt(a.stop)}</td>`;
      tbody.appendChild(tr);
      tr.querySelector('a')?.addEventListener('click', ()=> loadChart((a.symbol||'BTC') + 'USD'));
    });
    if (rows[0]) loadChart((rows[0].symbol||'BTC') + 'USD');
    document.getElementById('lastApi').textContent = 'Alerts loaded';
  } catch(e){ console.error(e); document.getElementById('lastApi').textContent = 'Alerts load failed'; }
}

async function loadDiagnosticsJSON(){
  try {
    const r = await apiGet({ type:'diagnosticsJSON', t:Date.now() });
    const j = await r.json();
    const arr = j.data || [];
    document.getElementById('diag').textContent = arr.map(x => `${x.ts} [${x.level}] ${x.msg}`).join('\n');
    const forcePublic = (arr || []).some(x => (x.msg || '').indexOf('FORCE_PUBLIC enabled') !== -1);
    document.getElementById('forcePublic').checked = !!forcePublic;
  } catch(e){ console.error(e); }
}

function fmt(v){ try { return Number(v).toLocaleString('en-IN',{maximumFractionDigits:4}); } catch(e){ return v; } }

document.getElementById('start').addEventListener('click', async ()=>{
  const strat = document.getElementById('strategy').value;
  await apiGet({ type:'start', strategy: strat });
  await refreshAll();
});
document.getElementById('stop').addEventListener('click', async ()=>{ await apiGet({ type:'stop' }); await refreshAll(); });
document.getElementById('manual').addEventListener('click', async ()=>{ await apiGet({ type:'manualScan' }); await refreshAll(); });
document.getElementById('refresh').addEventListener('click', async ()=>{ await refreshAll(); });

document.getElementById('applyForce').addEventListener('click', async ()=>{
  const adminKey = document.getElementById('adminKey').value.trim();
  if (!adminKey){ alert('Enter ADMIN_KEY to perform admin actions'); return; }
  const force = document.getElementById('forcePublic').checked;
  const u = new URL(WEB_APP_URL);
  u.searchParams.set('type','setProp');
  u.searchParams.set('adminKey', adminKey);
  u.searchParams.set('key','FORCE_PUBLIC');
  u.searchParams.set('value', force ? 'true' : 'false');
  const r = await fetch(u.toString(), { cache:'no-store' });
  const j = await r.json();
  if (j && j.success) { alert('Applied'); await refreshAll(); } else { alert('Admin action failed: ' + (j && j.error)); }
});

function loadChart(sym){
  const s = (sym||'BTCUSD').replace(/[^A-Za-z0-9]/g,'');
  document.getElementById('chart').src = `https://s.tradingview.com/widgetembed/?symbol=BINANCE:${encodeURIComponent(s)}&interval=60&theme=dark`;
}

(async function init(){ await refreshAll(); setInterval(refreshAll, 15000); })();
</script>
</body>
</html>
