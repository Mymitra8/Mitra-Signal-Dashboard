<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitra Signal - Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0b0f;
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #1a1b23;
            border: 1px solid #374151;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-running {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-stopped {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-connected {
            background: rgba(14, 165, 233, 0.1);
            color: #0ea5e9;
            border: 1px solid rgba(14, 165, 233, 0.3);
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .modal-content {
            background: #252730;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            border: 1px solid #374151;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }

        .modal-description {
            color: #a1a8b7;
            margin-bottom: 24px;
            text-align: center;
            line-height: 1.6;
        }

        .form-input {
            width: 100%;
            background: #1a1b23;
            border: 2px solid #374151;
            border-radius: 12px;
            padding: 16px;
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #00d4aa;
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #252730;
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border-color: #00d4aa;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 14px;
            color: #a1a8b7;
            font-weight: 500;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-description {
            font-size: 12px;
            color: #6b7280;
        }

        .control-panel {
            background: #252730;
            border: 1px solid #374151;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .control-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .control-subtitle {
            color: #a1a8b7;
            font-size: 16px;
            margin-bottom: 32px;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 32px;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #a1a8b7;
        }

        .form-select {
            background: #1a1b23;
            border: 2px solid #374151;
            border-radius: 12px;
            padding: 12px 16px;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #00d4aa;
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .btn {
            background: #1a1b23;
            border: 2px solid #374151;
            border-radius: 12px;
            padding: 16px 24px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #0ea5e9;
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            max-width: 350px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .notification.show {
            transform: translateX(0);
        }

        .system-status {
            background: #1a1b23;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .status-item {
            background: #252730;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #374151;
        }

        .status-item-title {
            font-size: 12px;
            color: #a1a8b7;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .status-item-value {
            font-size: 16px;
            color: #ffffff;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .control-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="modal" id="setupModal">
        <div class="modal-content">
            <h2 class="modal-title">üöÄ Welcome to Mitra Signal</h2>
            <p class="modal-description">
                To get started, please enter your Google Apps Script Web App URL. 
                This connects your dashboard to the trading bot backend.
            </p>
            <input type="url" 
                   class="form-input" 
                   id="gasUrlInput" 
                   placeholder="https://script.google.com/macros/s/your-script-id/exec"
                   value="">
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn btn-primary" onclick="saveGasUrl()" style="flex: 1;">
                    Connect
                </button>
                <button class="btn" onclick="showHelp()" style="flex: 1;">
                    Help
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">M</div>
                <div class="logo-text">Mitra Signal</div>
            </div>
            <div class="status-indicator" id="statusIndicator">
                <div class="pulse" id="statusPulse"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Active Strategy</span>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üìà</div>
                </div>
                <div class="stat-value" id="activeStrategy">Enhanced</div>
                <div class="stat-description">Current trading strategy</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Today's Alerts</span>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üö®</div>
                </div>
                <div class="stat-value" id="todayAlerts">0</div>
                <div class="stat-description">Signals sent today</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Alert Limit</span>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">‚ö°</div>
                </div>
                <div class="stat-value" id="alertLimit">5</div>
                <div class="stat-description">Daily maximum alerts</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Last Update</span>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üïí</div>
                </div>
                <div class="stat-value" id="lastUpdate" style="font-size: 18px;">Never</div>
                <div class="stat-description">Engine last activity</div>
            </div>
        </div>

        <div class="control-panel">
            <h2 class="control-title">Engine Control</h2>
            <p class="control-subtitle">Manage your trading bot and strategy settings</p>
            <div class="control-grid">
                <div class="control-section">
                    <div class="form-group">
                        <label class="form-label">Trading Strategy</label>
                        <select class="form-select" id="strategySelect">
                            <option value="Enhanced">Enhanced Multi-Strategy</option>
                            <option value="Ganu">Ganu Strategy (Conservative)</option>
                            <option value="Scalping">Quick Scalp (Aggressive)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="startBtn">
                        <span>üöÄ</span> Start Engine
                    </button>
                    <button class="btn btn-danger" id="stopBtn" disabled>
                        <span>‚èπÔ∏è</span> Stop Engine
                    </button>
                </div>

                <div class="control-section">
                    <button class="btn btn-secondary" id="manualScanBtn">
                        <span>üîç</span> Run Manual Scan
                    </button>
                    <button class="btn" id="testConnectionBtn">
                        <span>üß™</span> Test Connection
                    </button>
                    <a href="https://docs.google.com/spreadsheets/d/1_LnY1tsOjftlbBzYpWIew3dMgNhKxpoOsOWFE0Eg_Es/edit" 
                       target="_blank" class="btn">
                        <span>üìä</span> View Sheets
                    </a>
                    <button class="btn" onclick="resetConnection()">
                        <span>‚öôÔ∏è</span> Change URL
                    </button>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <h2 class="control-title">System Status</h2>
            <p class="control-subtitle">Monitor your trading bot performance</p>
            <div class="system-status">
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-item-title">Connection Status</div>
                        <div class="status-item-value" id="connectionStatus">Disconnected</div>
                    </div>
                    <div class="status-item">
                        <div class="status-item-title">Last API Call</div>
                        <div class="status-item-value" id="lastApiCall">Never</div>
                    </div>
                    <div class="status-item">
                        <div class="status-item-title">Sheet Access</div>
                        <div class="status-item-value" id="sheetAccess">Unknown</div>
                    </div>
                    <div class="status-item">
                        <div class="status-item-title">Telegram Status</div>
                        <div class="status-item-value" id="telegramStatus">Unknown</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gasUrl = '';
        let updateInterval = null;

        // Global storage variable for environments without localStorage
        let memoryStorage = {};

        // Safe storage functions
        function getStoredUrl() {
            try {
                return localStorage.getItem('mitraGasUrl') || memoryStorage.gasUrl || '';
            } catch (e) {
                return memoryStorage.gasUrl || '';
            }
        }

        function setStoredUrl(url) {
            try {
                localStorage.setItem('mitraGasUrl', url);
            } catch (e) {
                console.log('localStorage not available, using memory storage');
            }
            memoryStorage.gasUrl = url;
        }

        function removeStoredUrl() {
            try {
                localStorage.removeItem('mitraGasUrl');
            } catch (e) {
                console.log('localStorage not available');
            }
            delete memoryStorage.gasUrl;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedUrl = getStoredUrl();
            if (savedUrl) {
                gasUrl = savedUrl;
                document.getElementById('setupModal').style.display = 'none';
                initializeDashboard();
            } else {
                document.getElementById('setupModal').style.display = 'flex';
            }
        });

        function saveGasUrl() {
            const input = document.getElementById('gasUrlInput');
            const url = input.value.trim();
            
            if (!url) {
                showNotification('Please enter a valid URL', 'error');
                return;
            }

            if (!url.includes('script.google.com')) {
                showNotification('Please enter a valid Google Apps Script URL', 'error');
                return;
            }

            gasUrl = url;
            setStoredUrl(url);
            document.getElementById('setupModal').style.display = 'none';
            
            showNotification('Connection saved! Testing...', 'success');
            initializeDashboard();
        }

        function showHelp() {
            const helpText = `To get your Google Apps Script URL:

1. Go to script.google.com
2. Create a new project
3. Paste the Google Apps Script code
4. Deploy ‚Üí New Deployment ‚Üí Web App
5. Set access to "Anyone"
6. Copy the URL and paste it here

Need more help? Check the deployment guide!`;

            alert(helpText);
        }

        function resetConnection() {
            removeStoredUrl();
            gasUrl = '';
            document.getElementById('gasUrlInput').value = '';
            document.getElementById('setupModal').style.display = 'flex';
            
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        function initializeDashboard() {
            updateStatusIndicator('stopped', 'Connecting...');
            testConnection();
            setupEventListeners();
            startPeriodicUpdate();
        }

        function setupEventListeners() {
            document.getElementById('startBtn').addEventListener('click', startEngine);
            document.getElementById('stopBtn').addEventListener('click', stopEngine);
            document.getElementById('manualScanBtn').addEventListener('click', runManualScan);
            document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
        }

        async function makeRequest(action, data = {}) {
            if (!gasUrl) {
                showNotification('No connection URL configured', 'error');
                return null;
            }

            try {
                const payload = { action, ...data };
                
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Request failed:', error);
                updateStatusIndicator('stopped', 'Connection Error');
                document.getElementById('connectionStatus').textContent = 'Error';
                showNotification('Connection failed: ' + error.message, 'error');
                return null;
            }
        }

        async function testConnection() {
            const btn = document.getElementById('testConnectionBtn');
            btn.innerHTML = '<div class="loading"><div class="spinner"></div> Testing...</div>';
            btn.disabled = true;

            try {
                const response = await fetch(gasUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    updateStatusIndicator('connected', 'Connected');
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    document.getElementById('sheetAccess').textContent = 'OK';
                    showNotification('Connection successful!', 'success');
                    updateDashboard(result.data);
                } else if (result.success) {
                    updateStatusIndicator('connected', 'Connected');
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    showNotification('Connection successful!', 'success');
                } else {
                    throw new Error('Invalid response from server');
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                updateStatusIndicator('stopped', 'Connection Failed');
                document.getElementById('connectionStatus').textContent = 'Failed';
                document.getElementById('sheetAccess').textContent = 'Error';
                showNotification('Connection failed. Please check your URL.', 'error');
            }

            btn.innerHTML = '<span>üß™</span> Test Connection';
            btn.disabled = false;
        }

        async function startEngine() {
            const strategy = document.getElementById('strategySelect').value;
            const btn = document.getElementById('startBtn');
            
            btn.innerHTML = '<div class="loading"><div class="spinner"></div> Starting...</div>';
            btn.disabled = true;

            const result = await makeRequest('start', { strategy });
            
            if (result && result.success) {
                showNotification('Engine started successfully!', 'success');
                updateStatus();
            } else {
                showNotification('Failed to start engine: ' + (result?.error || 'Unknown error'), 'error');
                btn.innerHTML = '<span>üöÄ</span> Start Engine';
                btn.disabled = false;
            }
        }

        async function stopEngine() {
            const btn = document.getElementById('stopBtn');
            
            btn.innerHTML = '<div class="loading"><div class="spinner"></div> Stopping...</div>';
            btn.disabled = true;

            const result = await makeRequest('stop');
            
            if (result && result.success) {
                showNotification('Engine stopped successfully!', 'success');
                updateStatus();
            } else {
                showNotification('Failed to stop engine: ' + (result?.error || 'Unknown error'), 'error');
                btn.innerHTML = '<span>‚èπÔ∏è</span> Stop Engine';
                btn.disabled = false;
            }
        }

        async function runManualScan() {
            const strategy = document.getElementById('strategySelect').value;
            const btn = document.getElementById('manualScanBtn');
            
            btn.innerHTML = '<div class="loading"><div class="spinner"></div> Scanning...</div>';
            btn.disabled = true;

            const result = await makeRequest('manualScan', { strategy });
            
            if (result && result.success) {
                showNotification('Manual scan completed!', 'success');
                updateStatus();
            } else {
                showNotification('Manual scan failed: ' + (result?.error || 'Unknown error'), 'error');
            }

            btn.innerHTML = '<span>üîç</span> Run Manual Scan';
            btn.disabled = false;
        }

        async function updateStatus() {
            if (!gasUrl) return;

            try {
                const response = await fetch(gasUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    updateDashboard(result.data);
                } else {
                    console.log('Status update failed:', result);
                }
            } catch (error) {
                console.error('Status update failed:', error);
            }
        }

        function updateDashboard(status) {
            updateStatusIndicator(
                status.isRunning ? 'running' : 'connected',
                status.isRunning ? 'Running' : 'Connected'
            );

            document.getElementById('activeStrategy').textContent = status.activeStrategy || 'Enhanced';
            document.getElementById('todayAlerts').textContent = status.dailyAlerts || '0';
            document.getElementById('alertLimit').textContent = status.maxDailyAlerts || '5';
            
            if (status.lastUpdate) {
                try {
                    const date = new Date(status.lastUpdate);
                    document.getElementById('lastUpdate').textContent = date.toLocaleTimeString();
                } catch (e) {
                    document.getElementById('lastUpdate').textContent = 'Just now';
                }
            }

            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const strategySelect = document.getElementById('strategySelect');

            if (status.isRunning) {
                startBtn.disabled = true;
                startBtn.innerHTML = '<span>üöÄ</span> Engine Running';
                stopBtn.disabled = false;
                stopBtn.innerHTML = '<span>‚èπÔ∏è</span> Stop Engine';
                strategySelect.disabled = true;
            } else {
                startBtn.disabled = false;
                startBtn.innerHTML = '<span>üöÄ</span> Start Engine';
                stopBtn.disabled = true;
                stopBtn.innerHTML = '<span>‚èπÔ∏è</span> Stopped';
                strategySelect.disabled = false;
            }

            if (status.activeStrategy && strategySelect.value !== status.activeStrategy) {
                strategySelect.value = status.activeStrategy;
            }

            // Update system status
            document.getElementById('connectionStatus').textContent = 'Connected';
            if (status.lastApiCall && status.lastApiCall > 0) {
                const lastCall = new Date(status.lastApiCall);
                document.getElementById('lastApiCall').textContent = lastCall.toLocaleTimeString();
            }
        }

        function updateStatusIndicator(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const pulse = document.getElementById('statusPulse');
            const statusText = document.getElementById('statusText');

            indicator.className = `status-indicator status-${status}`;
            
            if (status === 'running') {
                pulse.style.backgroundColor = '#10b981';
            } else if (status === 'connected') {
                pulse.style.backgroundColor = '#0ea5e9';
            } else {
                pulse.style.backgroundColor = '#ef4444';
            }
            
            statusText.textContent = text;
        }

        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            requestAnimationFrame(() => {
                notification.classList.add('show');
            });
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.
