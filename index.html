<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mitra Signals Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #283593;
      color: #fff;
      padding: 1rem 2rem;
      font-size: 1.4rem;
      font-weight: bold;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #283593;
    }
    button {
      background: #283593;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      margin: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #3f51b5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 0.9rem;
      text-align: center;
    }
    th {
      background: #eee;
    }
    .status {
      font-size: 0.9rem;
      margin-top: 10px;
    }
    select {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <header>Mitra Signals — Dashboard</header>
  <div class="container">
    
    <!-- Engine Control -->
    <div class="card">
      <h2>Engine Control</h2>
      <button onclick="api('start')">▶ Start</button>
      <button onclick="api('stop')">⏸ Stop</button>
      <button onclick="api('manual')">⚡ Manual Tick</button>
      <div class="status" id="engineStatus">Loading status...</div>
      <label>Strategy:
        <select id="strategySelect" onchange="changeStrategy()">
          <option>MomentumBurst</option>
          <option>TrendRider</option>
          <option>VolumeSurge</option>
          <option>MeanRevertSnap</option>
        </select>
      </label>
    </div>
    
    <!-- Diagnostics -->
    <div class="card">
      <h2>Diagnostics</h2>
      <pre id="diagBox">Loading...</pre>
    </div>
    
    <!-- Alerts -->
    <div class="card" style="grid-column: span 2;">
      <h2>Latest Alerts</h2>
      <table>
        <thead>
          <tr>
            <th>Time</th><th>Coin</th><th>Sym</th>
            <th>Price</th><th>Conf%</th><th>Entry</th><th>TP</th><th>SL</th>
            <th>Strat</th><th>Timeline</th>
          </tr>
        </thead>
        <tbody id="alertsTable"></tbody>
      </table>
    </div>
    
  </div>
  
  <script>
    const base = ScriptApp.getService().getUrl ? ScriptApp.getService().getUrl() : ''; 
    // If deployed, replace with your Web App URL:
    // const base = 'https://script.google.com/macros/s/AKfycbxxxx/exec';

    async function api(type) {
      const res = await fetch(base + '?type=' + type);
      const js = await res.json();
      console.log(type, js);
      loadDiagnostics();
      if(type==='alerts'||type==='manual') loadAlerts();
      if(type==='start'||type==='stop') loadDiagnostics();
    }
    
    async function loadDiagnostics() {
      const res = await fetch(base + '?type=diagnostics');
      const js = await res.json();
      document.getElementById('diagBox').innerText = JSON.stringify(js.data,null,2);
      document.getElementById('engineStatus').innerText = 
        'Running: ' + js.data.isRunning + ' | Strategy: ' + js.data.activeStrategy;
      document.getElementById('strategySelect').value = js.data.activeStrategy;
    }
    
    async function loadAlerts() {
      const res = await fetch(base + '?type=alerts');
      const js = await res.json();
      const tbody = document.getElementById('alertsTable');
      tbody.innerHTML = '';
      js.alerts.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.time}</td><td>${a.coin}</td><td>${a.sym}</td>
                        <td>${a.price}</td><td>${a.conf}</td>
                        <td>${a.entry}</td><td>${a.tp}</td><td>${a.sl}</td>
                        <td>${a.strategy}</td><td>${a.timeline}</td>`;
        tbody.appendChild(tr);
      });
    }
    
    function changeStrategy(){
      const strat = document.getElementById('strategySelect').value;
      api('changeStrategy&strategy='+encodeURIComponent(strat));
    }
    
    // Auto-refresh
    loadDiagnostics(); loadAlerts();
    setInterval(loadDiagnostics, 15000);
    setInterval(loadAlerts, 20000);
  </script>
</body>
</html>
