<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mitra Signal — Dashboard</title>
<style>
  :root{--bg:#0b0c10;--card:#0f1720;--accent:#60a5fa;--muted:#98a8b6;--success:#10b981;--danger:#ef4444}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6eef6}
  .app{max-width:1200px;margin:18px auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-box{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-weight:700}
  h1{font-size:18px;margin:0}
  .tabs{display:flex;gap:8px;margin-top:18px}
  .tab{padding:10px 14px;border-radius:10px;background:var(--card);cursor:pointer;color:var(--muted)}
  .tab.active{background:linear-gradient(135deg,#0f1720,#111827);color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:18px}
  .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .full{grid-column:1/-1}
  .label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .value{font-size:20px;font-weight:700}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  select,button{padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#e6eef6}
  button.primary{background:var(--accent);color:#042028;font-weight:700}
  button.danger{background:var(--danger);color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  thead th{color:var(--muted);font-weight:600}
  .coin-link{color:var(--accent);cursor:pointer;text-decoration:underline}
  .small{font-size:12px;color:var(--muted)}
  iframe{width:100%;height:420px;border-radius:8px;border:0;margin-top:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="logo-box">M</div>
        <div>
          <h1>Mitra Signal — Trading Dashboard</h1>
          <div class="small">Live strategy control • Diagnostics • Alerts • Live chart</div>
        </div>
      </div>
      <div class="small">Web App: <span id="webUrlLabel"></span></div>
    </header>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="panel">Dashboard</div>
      <div class="tab" data-tab="alerts">Trade Alerts</div>
      <div class="tab" data-tab="diag">Diagnostics</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">Engine Status</div>
        <div id="engineStatus" class="value">Loading…</div>
        <div id="engineSub" class="small">—</div>
      </div>

      <div class="card">
        <div class="label">Active Strategy</div>
        <div id="activeStrategy" class="value">—</div>
        <div id="strategyDesc" class="small">—</div>
      </div>

      <div class="card">
        <div class="label">Today's Alerts</div>
        <div id="todayAlerts" class="value">0</div>
        <div class="small">Limit: <span id="alertLimit">0</span></div>
      </div>

      <div class="card full">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="label">Controls</div>
            <div class="controls" style="margin-top:8px">
              <select id="strategySelect">
                <option value="Enhanced">Enhanced</option>
                <option value="Ganu">Ganu</option>
                <option value="Scalping">Scalping</option>
              </select>
              <button id="startBtn" class="primary">Start Engine</button>
              <button id="stopBtn" class="danger">Stop Engine</button>
              <button id="manualBtn" class="">Manual Scan</button>
              <button id="testBtn" class="">Send Telegram Test</button>
            </div>
          </div>
          <div style="text-align:right">
            <div class="label">Last API</div>
            <div id="lastApiCall" class="small">Never</div>
            <div id="telegramStatus" class="small">Telegram: checking…</div>
          </div>
        </div>
      </div>

      <div id="panel" class="card full tab-pane">
        <h3 style="margin:0 0 8px 0">Overview</h3>
        <div class="small">Use controls to manage the engine. Alerts will appear in Trade Alerts tab and will be logged to the Google Sheet.</div>
      </div>

      <div id="alerts" class="card full tab-pane" style="display:none">
        <h3 style="margin:0 0 8px 0">Recent Trade Alerts</h3>
        <table>
          <thead>
            <tr><th>Time</th><th>Symbol</th><th>Coin</th><th>Price</th><th>Confidence</th></tr>
          </thead>
          <tbody id="alertsBody"><tr><td colspan="5">Loading…</td></tr></tbody>
        </table>

        <div id="chartWrap">
          <h4 id="chartTitle">Live Chart</h4>
          <iframe id="chartFrame" src=""></iframe>
        </div>
      </div>

      <div id="diag" class="card full tab-pane" style="display:none">
        <h3 style="margin:0 0 8px 0">Diagnostics (last 50)</h3>
        <table>
          <thead><tr><th>Time</th><th>Level</th><th>Message</th></tr></thead>
          <tbody id="diagBody"><tr><td colspan="3">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // Replace WEB_APP_URL if your deployed Apps Script URL differs
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwBXjQ0IlDtzgFah5KxPr2zdeQLD-WdJT-6YEdiFMX3wnw-ciET2wo2XCqyquVRQ9w5/exec";
  document.getElementById('webUrlLabel').textContent = WEB_APP_URL;

  // JSONP helper
  function jsonp(action, params = {}) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2,9);
      window[cb] = function(res) { try { resolve(res); } finally { cleanup(); } };
      function cleanup() { delete window[cb]; const el = document.getElementById(cb); if (el) el.remove(); }
      const url = new URL(WEB_APP_URL);
      url.searchParams.set('action', action);
      url.searchParams.set('callback', cb);
      Object.keys(params||{}).forEach(k => url.searchParams.set(k, params[k]));
      const s = document.createElement('script'); s.src = url.toString(); s.id = cb;
      s.onerror = () => { cleanup(); reject(new Error('JSONP load failed')); };
      document.head.appendChild(s);
    });
  }

  // Tabs
  document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const target = t.getAttribute('data-tab');
      document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
      document.getElementById(target).style.display = 'block';
      if (target === 'alerts') loadAlerts();
      if (target === 'diag') loadDiagnostics();
      if (target === 'panel') loadStatus();
    });
  });

  // Controls
  document.getElementById('startBtn').addEventListener('click', async () => {
    const strategy = document.getElementById('strategySelect').value;
    await jsonp('startEngine', { strategy });
    alert('Start requested — check Diagnostics for confirmation');
    setTimeout(loadStatus, 1000);
  });
  document.getElementById('stopBtn').addEventListener('click', async () => {
    await jsonp('stopEngine');
    setTimeout(loadStatus, 1000);
    alert('Stop requested');
  });
  document.getElementById('manualBtn').addEventListener('click', async () => {
    await jsonp('manualScan');
    alert('Manual scan requested — check Diagnostics & Trade Alerts');
    setTimeout(()=>{ loadAlerts(); loadDiagnostics(); }, 1500);
  });
  document.getElementById('testBtn').addEventListener('click', async () => {
    await jsonp('sendTestMessage');
    alert('Telegram test requested — check Diagnostics');
  });

  // Loaders
  async function loadStatus() {
    try {
      const res = await jsonp('getStatus');
      if (!res || !res.success || !res.data) return;
      const d = res.data;
      document.getElementById('engineStatus').textContent = d.isRunning ? '✅ Running' : '⛔ Stopped';
      document.getElementById('engineSub').textContent = 'Last update: ' + (d.lastUpdate || new Date().toLocaleString());
      document.getElementById('activeStrategy').textContent = d.activeStrategy || '-';
      document.getElementById('todayAlerts').textContent = d.todayAlerts || 0;
      document.getElementById('alertLimit').textContent = d.alertLimit || '-';
      document.getElementById('strategySelect').value = d.activeStrategy || 'Enhanced';
      document.getElementById('telegramStatus').textContent = d.telegramConfigured ? 'Telegram: configured' : 'Telegram: not configured';
      if (d.lastApiCall && d.lastApiCall > 0) {
        document.getElementById('lastApiCall').textContent = new Date(d.lastApiCall).toLocaleString();
      } else {
        document.getElementById('lastApiCall').textContent = 'Never';
      }
    } catch (err) {
      console.error('loadStatus', err);
    }
  }

  async function loadDiagnostics() {
    try {
      const res = await jsonp('getDiagnostics');
      const rows = (res && res.success && res.data) ? res.data : [];
      const tbody = document.getElementById('diagBody'); tbody.innerHTML = '';
      if (!rows.length) { tbody.innerHTML = '<tr><td colspan="3">No logs</td></tr>'; return; }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(r.time).toLocaleString()}</td><td class="level-${r.level}">${r.level}</td><td>${r.message}</td>`;
        tbody.appendChild(tr);
      });
    } catch (err) {
      document.getElementById('diagBody').innerHTML = '<tr><td colspan="3">Error loading logs</td></tr>';
      console.error('loadDiagnostics', err);
    }
  }

  async function loadAlerts() {
    try {
      const res = await jsonp('getTradeAlerts');
      const rows = (res && res.success && res.data) ? res.data : [];
      const tbody = document.getElementById('alertsBody'); tbody.innerHTML = '';
      if (!rows.length) { tbody.innerHTML = '<tr><td colspan="5">No trade alerts</td></tr>'; return; }
      rows.forEach(r => {
        const sym = (r.symbol || r.coin || '').toUpperCase();
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(r.time).toLocaleString()}</td>
                        <td><span class="coin-link" onclick="showChart('${sym}')">${sym}</span></td>
                        <td>${r.coin || ''}</td>
                        <td>${r.price || ''}</td>
                        <td>${r.confidence || ''}</td>`;
        tbody.appendChild(tr);
      });
    } catch (err) {
      document.getElementById('alertsBody').innerHTML = '<tr><td colspan="5">Error loading alerts</td></tr>';
      console.error('loadAlerts', err);
    }
  }

  window.showChart = function(symbol) {
    if (!symbol) return;
    const upper = symbol.toUpperCase().replace(/[^A-Z0-9]/g,'');
    const iframe = document.getElementById('chartFrame');
    iframe.src = `https://s.tradingview.com/widgetembed/?symbol=BINANCE:${upper}USDT&interval=30&hidesidetoolbar=1&symboledit=1`;
    document.getElementById('chartTitle').textContent = 'Live Chart — ' + upper;
    // switch to alerts tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-tab="alerts"]').classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
    document.getElementById('alerts').style.display = 'block';
  };

  // auto-refresh
  setInterval(loadStatus, 30000);
  setInterval(loadDiagnostics, 60000);
  setInterval(loadAlerts, 60000);

  // initial load
  loadStatus(); loadDiagnostics(); loadAlerts();
</script>
</body>
</html>
