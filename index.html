<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mitra Signal — Crypto Dashboard</title>
<style>
:root{
  --bg:#0b0f14; --panel:#121824; --muted:#7b8a9a; --text:#e8f0ff;
  --accent:#4da3ff; --ok:#27c281; --warn:#ffb020; --err:#ff5d5d;
  --chip:#1a2233;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu}
a{color:var(--accent);text-decoration:none}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px}
.header{display:flex;align-items:center;gap:16px;margin-bottom:16px}
.badge{width:40px;height:40px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#001b33;font-weight:800}
h1{font-size:22px;margin:0}
.sub{color:var(--muted);font-size:12px}
.panel{background:var(--panel);border:1px solid #1d2636;border-radius:12px;padding:16px}
.grid{display:grid;gap:16px}
.grid3{grid-template-columns:repeat(3,1fr)}
.kv{display:flex;flex-direction:column;gap:6px}
.kv .title{color:var(--muted);font-size:12px}
.kv .value{font-size:20px;font-weight:700}
.row{display:flex;gap:12px;flex-wrap:wrap}
select,button{background:#121723;color:var(--text);border:1px solid #2a354a;border-radius:10px;padding:10px 12px}
button.accent{background:#0e2a45;border-color:#1e4775}
button.danger{background:#3a1420;border-color:#6f2141}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1d2636;font-size:13px}
th{color:var(--muted);text-align:left}
.badgeState{display:inline-flex;align-items:center;gap:6px;background:var(--chip);padding:6px 10px;border-radius:999px}
.dot{width:10px;height:10px;border-radius:50%}
.dot.ok{background:var(--ok)}
.dot.off{background:var(--err)}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{background:#111827;color:#b7c6db;border:1px solid #1f2a3c;padding:8px 12px;border-radius:10px;cursor:pointer}
.tab.active{color:#fff;background:#162235}
.hide{display:none}
.footer{margin:20px 0;color:var(--muted);font-size:12px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chips button{padding:6px 10px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="badge">M</div>
    <div>
      <h1>Mitra Signal — Crypto Dashboard</h1>
      <div class="sub">Real-time control • Diagnostics • Trade Alerts</div>
    </div>
  </div>

  <div class="panel">
    <div class="sub" id="webappLink">Web App: <a target="_blank" id="gsLink"></a></div>
    <div class="tabs">
      <div class="tab active" data-tab="dash">Dashboard</div>
      <div class="tab" data-tab="alerts">Trade Alerts</div>
      <div class="tab" data-tab="diag">Diagnostics</div>
    </div>

    <!-- DASH -->
    <div id="dash" class="grid grid3">
      <div class="panel kv">
        <div class="title">Engine Status</div>
        <div class="value"><span class="badgeState"><span id="engDot" class="dot off"></span><span id="engText">Stopped</span></span></div>
        <div class="sub" id="lastUpdate">Last update: —</div>
      </div>
      <div class="panel kv">
        <div class="title">Active Strategy</div>
        <div class="value" id="strategy">—</div>
        <div class="sub">Switch below</div>
      </div>
      <div class="panel kv">
        <div class="title">Today’s Alerts</div>
        <div class="value" id="today">0</div>
        <div class="sub" id="limitText">Limit: —</div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row">
          <select id="strategySel">
            <option>Ganu</option>
            <option>Enhanced</option>
            <option>Scalping</option>
          </select>
          <button id="startBtn" class="accent">Start Engine</button>
          <button id="stopBtn" class="danger">Stop Engine</button>
          <button id="scanBtn">Manual Scan</button>
          <button id="tgBtn">Send Telegram Test</button>
        </div>
        <div class="chips">
          <button class="tf" data-tf="15">15m</button>
          <button class="tf" data-tf="60">1h</button>
          <button class="tf" data-tf="240">4h</button>
          <button class="tf" data-tf="D">1D</button>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <div id="tvwrap" style="height:420px">
        <iframe id="tv" title="Chart" style="width:100%;height:100%;border:0;border-radius:12px;background:#0b0f14"></iframe>
      </div>
    </div>

    <!-- ALERTS -->
    <div id="alerts" class="panel hide">
      <table>
        <thead>
          <tr><th>Time</th><th>Symbol</th><th>Coin</th><th>Strategy</th><th>Conf</th><th>Entry</th><th>TP</th><th>SL</th><th>Duration</th><th>Vol</th><th>Δ24h%</th></tr>
        </thead>
        <tbody id="alertRows"></tbody>
      </table>
    </div>

    <!-- DIAG -->
    <div id="diag" class="panel hide">
      <pre id="diagText" style="white-space:pre-wrap;max-height:420px;overflow:auto;margin:0"></pre>
    </div>

    <div class="footer">© Mitra Signal — runs every 5 minutes automatically.</div>
  </div>
</div>

<script>
const GS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxi2iD44e_wBojx2Tz1fQxgFvTUZXuEjfsWCceG6j4hy_qTYsN3wld_SC4eHXdNp39V/exec";

const el = (id)=>document.getElementById(id);
el('gsLink').textContent = GS_WEB_APP_URL;
el('gsLink').href = GS_WEB_APP_URL;

function setTab(tab){
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tab));
  document.getElementById('dash').classList.toggle('hide', tab!=='dash');
  document.getElementById('alerts').classList.toggle('hide', tab!=='alerts');
  document.getElementById('diag').classList.toggle('hide', tab!=='diag');
}
document.querySelectorAll('.tab').forEach(t => t.onclick = ()=>setTab(t.dataset.tab));

async function getJSON(url){
  const r = await fetch(url, { cache: 'no-store' });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function postJSON(url, body){
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

async function refresh(){
  try{
    const s = await getJSON(GS_WEB_APP_URL+'?type=status');
    el('engText').textContent = s.isRunning?'Running':'Stopped';
    el('engDot').classList.toggle('ok', s.isRunning);
    el('engDot').classList.toggle('off', !s.isRunning);
    el('strategy').textContent = s.strategy || '—';
    el('today').textContent = s.todayAlerts ?? 0;
    el('limitText').textContent = 'Limit: ' + (s.limit ?? '-');
    el('lastUpdate').textContent = 'Last update: ' + new Date().toISOString();
  }catch(e){console.error(e)}
  refreshAlerts();
  refreshDiag();
}
async function refreshAlerts(){
  try{
    const a = await getJSON(GS_WEB_APP_URL+'?type=alerts');
    const rows = (a.data||[]).map(r=>{
      return `<tr>
        <td>${new Date(r.time).toLocaleString()}</td>
        <td>${r.symbol||''}</td>
        <td>${r.name||''}</td>
        <td>${r.strategy||''}</td>
        <td>${r.confidence||''}%</td>
        <td>$${fmt(r.entry)}</td>
        <td>$${fmt(r.target)}</td>
        <td>$${fmt(r.stop)}</td>
        <td>${r.timeframe||''}</td>
        <td>${num(r.volume)}</td>
        <td>${fmt(r.change24)}%</td>
      </tr>`;
    }).join('');
    el('alertRows').innerHTML = rows || '<tr><td colspan="11">No alerts yet.</td></tr>';
    // update chart symbol to the last alert
    if ((a.data||[]).length){
      const sym = a.data[0].symbol || 'BTC';
      loadTV(sym);
    }
  }catch(e){console.error(e)}
}
async function refreshDiag(){
  try{
    const txt = await fetch(GS_WEB_APP_URL+'?type=diagnostics').then(r=>r.text());
    el('diagText').textContent = txt || 'No diagnostics yet.';
  }catch(e){console.error(e)}
}

function fmt(n){ return Number(n||0).toFixed(2); }
function num(n){ return Number(n||0).toLocaleString(); }

el('startBtn').onclick = async ()=>{
  const strategy = el('strategySel').value;
  await postJSON(GS_WEB_APP_URL, { action:'start', strategy });
  refresh();
};
el('stopBtn').onclick = async ()=>{
  await postJSON(GS_WEB_APP_URL, { action:'stop' });
  refresh();
};
el('scanBtn').onclick = async ()=>{
  await postJSON(GS_WEB_APP_URL, { action:'scan' });
  refresh();
};
el('tgBtn').onclick = async ()=>{
  await postJSON(GS_WEB_APP_URL, { action:'tg_test' });
  alert('Telegram test sent (check bot).');
};

function loadTV(symbol){
  // Basic TradingView embed via tv widget URL
  const s = (symbol||'BTC').toUpperCase() + 'USDT';
  const tf = window._tf || '60';
  const url = `https://s.tradingview.com/widgetembed/?frameElementId=tvchart&symbol=BINANCE%3A${encodeURIComponent(s)}&interval=${encodeURIComponent(tf)}&hidesidetoolbar=1&symboledit=1&saveimage=0&toolbarbg=rgba(19%2C23%2C34%2C1)&studies=&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&allow_symbol_change=1&hideideas=1`;
  el('tv').src = url;
}
document.querySelectorAll('.tf').forEach(b=>{
  b.onclick = ()=>{ window._tf = b.dataset.tf; loadTV('BTC'); };
});

refresh();
setInterval(refresh, 15000); // refresh every 15s
loadTV('BTC');
</script>
</body>
</html>
